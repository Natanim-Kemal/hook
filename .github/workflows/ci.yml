name: CI/CD Security Analysis Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./src
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ../requirements.txt
          pip install pytest pytest-cov
      
      - name: Run unit tests
        run: |
          cd ..
          pytest tests/ -v --tb=short || echo "Tests completed (some may have failed)"

  static-analysis:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Semgrep SAST Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/python
            p/javascript
            p/owasp-top-ten
        continue-on-error: true
      
      - name: Run Semgrep and save report
        run: |
          pip install semgrep
          semgrep scan --config=auto --json --output=semgrep-results.json . || true
          semgrep scan --config=auto . > semgrep-results.txt || true
        continue-on-error: true
      
      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: |
            semgrep-results.json
            semgrep-results.txt
        if: always()

  dynamic-analysis:
    runs-on: ubuntu-latest
    needs: static-analysis
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          cd src
          python -m pip install --upgrade pip
          pip install -r ../requirements.txt
      
      - name: Create dummy model for testing
        run: |
          cd src
          python -c "
          import joblib
          from sklearn.ensemble import RandomForestClassifier
          from sklearn.preprocessing import StandardScaler
          import numpy as np
          
          X = np.random.rand(100, 18)
          y = np.random.randint(0, 2, 100)
          model = RandomForestClassifier(n_estimators=10, random_state=42)
          model.fit(X, y)
          joblib.dump(model, 'model.pkl')
          
          scaler = StandardScaler()
          scaler.fit(X)
          joblib.dump(scaler, 'scaler.pkl')
          print('Dummy model and scaler created successfully')
          "
      
      - name: Start Flask API in background
        run: |
          cd src
          python api.py &
          echo $! > flask_pid.txt
          sleep 5
      
      - name: Wait for API to be ready
        run: |
          for i in {1..30}; do
            if curl -s http://127.0.0.1:5000/health > /dev/null; then
              echo "API is ready!"
              break
            fi
            echo "Waiting for API... ($i/30)"
            sleep 2
          done
      
      - name: Verify API is running
        run: |
          curl -v http://127.0.0.1:5000/health || echo "Health check failed"
      
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://127.0.0.1:5000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
        continue-on-error: true
      
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: report_html.html
        if: always()
      
      - name: Stop Flask API
        run: |
          if [ -f src/flask_pid.txt ]; then
            kill $(cat src/flask_pid.txt) || true
          fi
        if: always()

  security-summary:
    runs-on: ubuntu-latest
    needs: [static-analysis, dynamic-analysis]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports
      
      - name: Generate Security Summary
        run: |
          echo "# Security Analysis Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "## Static Analysis (Semgrep)" >> security-summary.md
          echo "See semgrep-report artifact for detailed findings." >> security-summary.md
          echo "" >> security-summary.md
          echo "## Dynamic Analysis (OWASP ZAP)" >> security-summary.md
          echo "See zap-report artifact for detailed findings." >> security-summary.md
          echo "" >> security-summary.md
          echo "Generated at: $(date)" >> security-summary.md
          cat security-summary.md
      
      - name: Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
